# **Product Requirements Document: Kanora Media Server MVP**

The table below outlines the **functional requirements** that make up the first shippable version of Kanora.  Track progress in your editor by changing the trailing **Status** column from `TODO` → `DONE`.

| Req ID    | Category  | Description                                                  | User Story (Who / What / Why)                                            | Expected Behavior / Acceptance Criteria                                    | Status |
| --------- | --------- | ------------------------------------------------------------ | ------------------------------------------------------------------------ | -------------------------------------------------------------------------- | ------ |
| **FR001** | Auth      | Register new account (`POST /auth/register`)                 | As a new user, I want to create an account so I can log in.              | Validates email & strong password, returns token pair + profile.           | TODO   |
| **FR002** | Auth      | Login (`POST /auth/login`)                                   | As a user, I want to log in so I can access the app.                     | Accepts email/password, returns valid JWT access & refresh tokens.         | TODO   |
| **FR003** | Auth      | Refresh token (`POST /auth/refresh`)                         | As a user, I want my app to stay logged in without re‑entering password. | Supply refresh token → new access+refresh pair. Refresh token jti rotated. | TODO   |
| **FR004** | Auth      | Logout (`POST /auth/logout`)                                 | As a user, I want to log out everywhere on this device.                  | Refresh token revoked in DB; subsequent refresh attempts fail with 401.    | TODO   |
| **FR005** | Users     | List users (`GET /users`)                                    | As an admin, I want to see every account so I can manage access.         | Returns paginated list; requires ADMIN role.                               | TODO   |
| **FR006** | Users     | Create user (`POST /users`)                                  | As an admin, I want to add accounts for my family.                       | Creates user with role USER by default; email uniqueness enforced.         | TODO   |
| **FR007** | Users     | Update / disable user (`PUT`,`DELETE /users/{id}`)           | As an admin, I want to update roles or disable access.                   | Changes saved; disabled user cannot log in; soft‑delete flag stored.       | TODO   |
| **FR008** | Users     | Self profile (`GET /me`)                                     | As a user, I want to view my profile details.                            | Returns current account fields.                                            | TODO   |
| **FR009** | Users     | Self update (`PUT /me`)                                      | As a user, I want to change my display name or password.                 | Validates fields; forces re‑login if password changed.                     | TODO   |
| **FR010** | Scanner   | Manual library scan (`POST /library/scan`)                   | As an admin, I want to trigger a full rescan after I copy files.         | Enqueues background job; returns 202 + job id.                             | TODO   |
| **FR011** | Scanner   | Scan progress (`GET /library/scan/status`)                   | As a user, I want to see scan progress so I know when music is ready.    | Returns % complete, current filename, error count.                         | TODO   |
| **FR012** | Scanner   | Watch folder auto‑import (`~/KanoraInbox`)                   | As a user, I want new tracks imported automatically when copied in.      | FS watcher debounces 3 s, queues imports, persists across restarts.        | TODO   |
| **FR013** | Scanner   | Metadata extraction                                          | As a user, I want correct tags so my library is organised.               | Reads ID3/FLAC tags with music‑metadata; missing tags set to "Unknown".    | TODO   |
| **FR014** | Scanner   | Duplicate detection by content‑hash                          | As a user, I don't want duplicate tracks clogging the library.           | SHA‑256 dedup; duplicates logged and skipped.                              | TODO   |
| **FR015** | Scanner   | Auto‑organise to Library (`~/KanoraMusic/<Artist>/<Album>/`) | As a user, I want my library folders tidy without manual work.           | Moves/renames files after successful import; configurable on/off.          | TODO   |
| **FR016** | Streaming | Range stream (`GET /tracks/{id}/stream`)                     | As a listener, I want to seek within a track.                            | Responds with 206 Partial Content & correct Content‑Range headers.         | TODO   |
| **FR017** | Streaming | MP3 192 kbps transcode (`?format=mp3`)                       | As a mobile user, I want smaller streams to save data.                   | On‑the‑fly ffmpeg transcode when format param present.                     | TODO   |
| **FR018** | Catalog   | List artists (`GET /artists`)                                | As a user, I want to browse artists alphabetically.                      | Paginated list; supports `?q` search, `?sort=name`.                        | TODO   |
| **FR019** | Catalog   | Artist details (`GET /artists/{id}`)                         | As a user, I want to see an artist’s albums.                             | Returns artist meta + album list.                                          | TODO   |
| **FR020** | Catalog   | Album details (`GET /albums/{id}`)                           | As a user, I want to view an album’s tracks & cover art.                 | Returns album meta + ordered track list + artwork URL.                     | TODO   |
| **FR021** | Catalog   | Track metadata update (`PUT /tracks/{id}`)                   | As a user, I want to fix wrong tags.                                     | Saves new tags to DB and optionally renames file.                          | TODO   |
| **FR022** | Playlists | Create / edit playlist (`POST /playlists`)                   | As a user, I want personal playlists.                                    | Saves playlist with ownerId; order preserved.                              | TODO   |
| **FR023** | Playlists | Add / remove / reorder tracks                                | As a user, I want to curate and reorder my playlist.                     | Endpoints add/remove track IDs & reorder array.                            | TODO   |
| **FR024** | Search    | Unified search (`GET /search?q=`)                            | As a user, I want one box to find anything.                              | Returns mixed result set (artists, albums, tracks, playlists).             | TODO   |
| **FR025** | System    | System info (`GET /system/info`)                             | As an admin, I want to check version & storage usage.                    | Returns JSON with version, uptime, DB counts, disk stats.                  | TODO   |
| **FR026** | System    | Settings update (`PUT /system/settings`)                     | As an admin, I want to change music paths & transcode toggle.            | Validates paths exist; restarts scanner if changed.                        | TODO   |
| **FR027** | DevOps    | Dockerfile & compose sample                                  | As a developer, I want one‑command deploy.                               | `docker compose up` starts server ready to scan.                           | TODO   |
| **FR028** | DevOps    | CI pipeline                                                  | As a developer, I want every PR tested.                                  | GitHub Actions: test, lint, build Docker image.                            | TODO   |
| **FR029** | Web       | Login + token storage                                        | As a web user, I want to log in via browser.                             | Next.js app stores tokens in secure (http‑only) cookies.                   | TODO   |
| **FR030** | Web       | Library browse & playback                                    | As a web user, I want to play music in my browser.                       | Axios calls API, HTML5 audio streams & shows cover art.                    | TODO   |
| **FR031** | Mobile    | Expo playback                                                | As a mobile user, I want to listen on my phone.                          | React Native app plays stream via AVPlayer/ExoPlayer.                      | TODO   |
| **FR032** | Quest     | VR playback room                                             | As a VR user, I want a virtual room with album art.                      | Basic Three.js mesh with controls mapped to stream.                        | TODO   |

> **Tip:** VS Code Markdown Preview will let you tick the `Status` cells (`TODO` → `DONE`) inline.
